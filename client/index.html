<!--
    Copyright (C) 2022  Schmuel Odradek
    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation; version 3.
    DSBLSP is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.
    You should have received a copy of the GNU General Public License
    along with this program.  If not, see <http://www.gnu.org/licenses/>.

    This product is a WIP. There are still a lot things to be done.
    The current version of the software is not meant to be already daily-driven
    in schools or companies.

    TODO: 
    - Master relative positioning on screen (Maybe Font mastering?)
    - Design account System (login and password) to prevent abuse

-->

<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
        <title>Digitales Schwarzes Brett</title>
    </head>

    <body>
        <h1>Live Information Screen</h1>
        <div id="screen"></div>
        <div id="input" style="float:left">
            <h2>Input</h2>
            <textarea id="msg" type="" cols="65" rows="5" placeholder="Type message"></textarea>
            <button type="submit" onclick="sendDate()">Send</button>
            <br>
            <button type="reset" onclick="erease()">Erease</button>
            <button type="reset" onclick="del()">Delete last</button>
        </div>


        <!--Scripts down here-->
        <script src="/socket.io/socket.io.js"></script>
        <script src="client/js/raphael/raphael.js"></script>
        <script>
                
            var socket = io();
            var paper = Raphael(document.getElementById("screen"), 800, 450);

            var movingElem = false;

            var sendDate = function(){
              
                socket.emit("date",{
                    text:document.getElementById("msg").value,
                    x:0.5,
                    y:0.25
                });

            }

            var erease = function(){

                socket.emit("erease", {
                    erease:"all"
                });

            }

            var del = function(){

                socket.emit("erease",{
                    erease:"last"
                });

            }

            /*
                This section defines the way how the text moves
            */

            move_start = function () {
                //storing original coordinates
                this.ox = this.attr('x');
                this.oy = this.attr('y');
                this.attr({opacity: 0.5});
                movingElem = true;
            };

            //visually change the text when it is being moved
            move_drag = function (dx, dy, x, y) {
                //move will be called with dx and dy
                this.attr({x: this.ox + dx, y: this.oy + dy});
                socket.emit("move",{
                    x: (this.ox + dx)/paper.width,
                    y: (this.oy + dy)/paper.height,
                    id: this.id
                });
                
            };

            //when the user lets go of the mouse button, reset the square's properties
            move_up = function () {
                //restoring the visual state
                this.attr({opacity: 1});
                movingElem = false;
            };

            var elements = [];
            socket.on("recentData",function(data){
                /*
                    This section is about aligning the elements on the paper correctly.
                    It sets the preferences of the background and style elements.
                    The for-loop iterates thru every Element of the received Dataset
                    and prints it to the Screen.

                    TODO: Only refresh the Text. Background and layout could be static to improve performance.
                */
                //paper.clear();
                
                if (!movingElem){
                    for(var i = 0; i < elements.length; i++){
                        elements[i].remove();
                    }

                    elements = [];

                    for (var i = 0; i<data.length; i++){
                        x=data[i].x*paper.width;
                        y=data[i].y*paper.height;
                        
                        elements.push({
                            text: data[i].text,
                            x: x,
                            y: y
                        });
                        
                    }
                    for(var i = 0; i < elements.length; i++) {
                        //extract the positional data from the json array
                        var px = elements[i].x;
                        var py = elements[i].y;
                        
                        //we need to make sure that the values are numerical for calculations later
                        px = parseInt(px);
                        py = parseInt(py);

                        //deal with this individual text, position it and show a status based on color
                        elements[i] = paper.text(px, py, elements[i].text).attr({
                            fill: "white",
                            font: "Arial",
                            "font-size": Math.floor(0.033*paper.height),
                            "text-anchor": "start",
                            cursor: "grabbing",
                        });
                        elements[i].id = i
                        
                        //define relations and functions for moving and positioning
                        //move the text
                        elements[i].drag(move_drag, move_start, move_up);
                    }
                }
            });

            socket.on("serverLog", function(data){
                console.log(data.log);
            });

            var init = function() {
                var bg = paper.rect(0, 0, window.innerWidth, window.innerHeight);
                var siteBarWhite = paper.rect(0.98*paper.width, 0, 0.01*paper.width, paper.height);
                var siteBarViolet = paper.rect(0.99*paper.width, 0, 0.01*paper.width, paper.height);
                var title = paper.text(0.5*paper.width, 0.047*paper.height, "Information").attr({
                    fill: "white",
                    font: "Arial",
                    "font-size": Math.floor(0.08*paper.height),
                    "font-family": "bold"
                });
                bg.attr({
                    fill: "black"
                });
                siteBarWhite.attr({
                    fill: "white",
                    stroke: "white"
                });
                siteBarViolet.attr({
                    fill: "#571c5b",
                    stroke: "#571c5b"
                });
                clock(0.94, 0.06, 0.03)
            }


            var clock = function(xrel, yrel, rrel){
                xpos=xrel*paper.width
                ypos=yrel*paper.height
                r=rrel*paper.width

                var c1 = paper.circle(xpos, ypos , r).attr({"stroke":"#fff", "stroke-width":2});
                var c2 = paper.circle(xpos, ypos, r*0.03334).attr({"fill":"#571c5b"});
                var sMark = paper.path("M "+ xpos + " " + ypos+" m 0 "+(-r+(0.0666*r))+" l 0 "+(-0.0666*r)).attr({"stroke":"#fff", "stroke-width":2});
                sMark.clone().attr({transform:"r30 "+ xpos + " " + ypos});
                sMark.clone().attr({transform:"r60 "+ xpos + " " + ypos});
                sMark.clone().attr({transform:"r120 "+ xpos + " " + ypos});
                sMark.clone().attr({transform:"r150 "+ xpos + " " + ypos});
                sMark.clone().attr({transform:"r210 "+ xpos + " " + ypos});
                sMark.clone().attr({transform:"r240 "+ xpos + " " + ypos});
                sMark.clone().attr({transform:"r300 "+ xpos + " " + ypos});
                sMark.clone().attr({transform:"r330 "+ xpos + " " + ypos});
                var lMark = paper.path("M "+ xpos + " " + ypos+" m 0 "+(-r+(0.133333*r))+" l 0 "+(-0.133333*r)).attr({"stroke":"#571c5b",  "stroke-width":4});
                lMark.clone().attr({transform:"r90 "+ xpos + " " + ypos});
                lMark.clone().attr({transform:"r180 "+ xpos + " " + ypos});
                lMark.clone().attr({transform:"r270 "+ xpos + " " + ypos});
                lMark.clone().attr({transform:"r360 "+ xpos + " " + ypos});
                var d = new Date();
                var hourAngle = (d.getHours() * 60 + d.getMinutes())/2, minAngle = (d.getMinutes() * 6), secAngle = (d.getSeconds() * 6);
                var secHand = paper.path("M "+ xpos + " " + ypos+", l 0"+(r*0.73333333333*-1)+", M "+ xpos + " " + ypos+", l 0" + (0.1*r)).attr({"stroke":"#571c5b", "stroke-width":2});
                var minHand = paper.path("M "+ xpos + " " + ypos+", l 0 "+(r*0.8*-1)).attr({"stroke":"#fff", 'stroke-width':2}).transform("r" + minAngle + " "+ xpos + " " + ypos);
                var hourHand = paper.path("M "+ xpos + " " + ypos+", l 0 "+(r*0.53333*-1)).attr({"stroke":"#fff", 'stroke-width':3, 'stroke-linecap':'round'}).transform("r" + hourAngle + " "+ xpos + " " + ypos);
                var secAnim = Raphael.animation({transform: "r360 "+ xpos + " " + ypos}, 60000).repeat(Infinity);
                var minAnim = Raphael.animation({transform: "r360 "+ xpos + " " + ypos}, 3600000).repeat(Infinity);
                var hourAnim = Raphael.animation({transform: "r360 "+ xpos + " " + ypos}, 43200000).repeat(Infinity);
                secHand.animate(secAnim); 
                minHand.animate(minAnim);
                hourHand.animate(hourAnim);
            }

            init(); 
        
        </script>

    </body>
</html>