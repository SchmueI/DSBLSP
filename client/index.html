<!--
    Copyright (C) 2022  Schmuel Odradek
    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation; version 3.
    DSBLSP is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.
    You should have received a copy of the GNU General Public License
    along with this program.  If not, see <http://www.gnu.org/licenses/>.

    This product is a WIP. There are still a lot things to be done.
    The current version of the software is not meant to be already daily-driven
    in schools or companies.

    TODO: 
    - Master relative positioning on screen (Maybe Font mastering?)
    - Design account System (login and password) to prevent abuse
    - Set Design standards

-->

<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
        <title>Digitales Schwarzes Brett</title>
    </head>

    <body>
        <h1>Live Information Screen</h1>
        <div id="screen"></div>
        <div id="input" style="float:left">
            <h2>Input</h2>
            <textarea id="msg" type="" cols="65" rows="5" placeholder="Type message"></textarea>
            <button type="submit" onclick="sendDate()">Send</button>
            <br>
            <button type="reset" onclick="erease()">Erease</button>
            <button type="reset" onclick="del()">Delete last</button>
        </div>


        <!--Scripts down here-->
        <script src="/socket.io/socket.io.js"></script>
        <script src="client/js/raphael/raphael.js"></script>
        <script>
                
            var socket = io();

            var paper = Raphael(document.getElementById("screen"), 800, 450);

            var sendDate = function(){
              
                socket.emit("date",{
                    text:document.getElementById("msg").value,
                    x:0.5,
                    y:0.25
                });

            }

            var erease = function(){

                socket.emit("erease", {
                    erease:"all"
                });

            }

            var del = function(){

                socket.emit("erease",{
                    erease:"last"
                });

            }

            /*
                This section defines the way how the text moves
            */

            move_start = function () {
                //storing original coordinates
                this.ox = this.attr('x');
                this.oy = this.attr('y');
                this.attr({opacity: 0.5});
            };

            //visually change the text when it is being moved
            move_drag = function (dx, dy, x, y) {
                //move will be called with dx and dy
                this.attr({x: this.ox + dx, y: this.oy + dy});
                socket.emit("move",{
                    x: (this.ox + dx)/paper.width,
                    y: (this.oy + dy)/paper.height,
                    id: this.id
                });
                
            };

            //when the user lets go of the mouse button, reset the square's properties
            move_up = function () {
                //restoring the visual state
                this.attr({opacity: 1});
            };

            socket.on("recentData",function(data){
                /*
                    This section is about aligning the elements on the paper correctly.
                    It sets the preferences of the background and style elements.
                    The for-loop iterates thru every Element of the received Dataset
                    and prints it to the Screen.

                    TODO: Only refresh the Text. Background and layout could be static to improve performance.
                */
                paper.clear();
                var elements = [];
                var ID_LIST = {};
                var bg = paper.rect(0, 0, window.innerWidth, window.innerHeight);
                var siteBarWhite = paper.rect(0.98*paper.width, 0, 0.01*paper.width, paper.height);
                var siteBarViolet = paper.rect(0.99*paper.width, 0, 0.01*paper.width, paper.height);

                for (var i = 0; i<data.length; i++){
                    x=data[i].x*paper.width;
                    y=data[i].y*paper.height;
                    
                    elements.push({
                        text: data[i].text,
                        x: x,
                        y: y
                    });
                    
                }
                for(var i = 0; i < elements.length; i++) {
                    //extract the positional data from the json array
                    var px = elements[i].x;
                    var py = elements[i].y;
                    
                    //we need to make sure that the values are numerical for calculations later
                    px = parseInt(px);
                    py = parseInt(py);

                    //deal with this individual text, position it and show a status based on color
                    elements[i] = paper.text(px, py, elements[i].text).attr({
                        fill: "white",
                        font: "Arial",
                        "font-size": Math.floor(0.033*paper.height),
                        "text-anchor": "start",
                        cursor: "grabbing",
                    });
                    elements[i].id = i
                    
                    //define relations and functions for moving and positioning
                    //move the text
                    elements[i].drag(move_drag, move_start, move_up);
		        }


                /*
                    This section defines the attributes of the elements on the screen.
                    Right now they are refreshed every frame. This should be static too.
                    (TODO)
                */
                bg.attr({
                    fill: "black"
                });
                siteBarWhite.attr({
                    fill: "white",
                    stroke: "white"
                });
                siteBarViolet.attr({
                    fill: "#571c5b",
                    stroke: "#571c5b"
                });
            });

            socket.on("serverLog", function(data){
                console.log(data.log);
            });
        
        </script>

    </body>
</html>